<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1920, height=1080">
  <title>GiveBit - Stream Overlay</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      width: 1920px;
      height: 1080px;
      overflow: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: transparent;
    }

    .donation-container {
      position: absolute;
      bottom: 100px;
      right: 50px;
      width: 500px;
      max-height: 800px;
      overflow: hidden;
    }

    .donation-alert {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      transform: translateX(600px);
      opacity: 0;
      animation: slideIn 0.5s ease-out forwards, slideOut 0.5s ease-in 4.5s forwards;
      border: 2px solid rgba(255, 255, 255, 0.2);
    }

    @keyframes slideIn {
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      to {
        transform: translateX(600px);
        opacity: 0;
      }
    }

    .donation-header {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }

    .donation-icon {
      width: 48px;
      height: 48px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-right: 12px;
    }

    .donation-title {
      color: white;
      font-size: 20px;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .donation-amount {
      color: #ffd700;
      font-size: 32px;
      font-weight: 800;
      margin: 8px 0;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
    }

    .donation-donor {
      color: rgba(255, 255, 255, 0.9);
      font-size: 16px;
      margin-bottom: 8px;
    }

    .donation-memo {
      color: rgba(255, 255, 255, 0.8);
      font-size: 14px;
      font-style: italic;
      line-height: 1.4;
      max-height: 60px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .connection-status {
      position: absolute;
      top: 20px;
      right: 20px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      display: none;
    }

    .connection-status.connected {
      background: rgba(34, 197, 94, 0.8);
    }

    .connection-status.disconnected {
      background: rgba(239, 68, 68, 0.8);
    }

    .connection-status.show {
      display: block;
    }
  </style>
</head>
<body>
  <div class="connection-status" id="connectionStatus">Connecting...</div>
  <div class="donation-container" id="donationContainer"></div>

  <script type="module">
    // Get URL parameters
    const params = new URLSearchParams(window.location.search);
    const projectId = params.get('projectId');
    const apiKey = params.get('apiKey');
    const mode = params.get('mode') || 'testnet';
    const showStatus = params.get('showStatus') === 'true';

    // Show connection status if requested
    const statusEl = document.getElementById('connectionStatus');
    if (showStatus) {
      statusEl.classList.add('show');
    }

    if (!projectId || !apiKey) {
      console.error('Missing projectId or apiKey in URL parameters');
      statusEl.textContent = 'Configuration Error';
      statusEl.classList.add('show', 'disconnected');
      throw new Error('Missing required parameters: projectId and apiKey');
    }

    // Import GiveBit SDK (using CDN)
    import('https://unpkg.com/@givebit/sdk@latest/dist/index.js').then(({ GiveBit }) => {
      const givebit = GiveBit.init({
        projectId,
        apiKey,
        mode,
      });

      givebit.connect().then(() => {
        console.log('‚úì Connected to GiveBit');
        statusEl.textContent = 'Connected';
        statusEl.classList.add('connected');
        statusEl.classList.remove('disconnected');
        
        // Hide status after 3 seconds if connected
        if (showStatus) {
          setTimeout(() => {
            statusEl.classList.remove('show');
          }, 3000);
        }
      }).catch((error) => {
        console.error('Connection failed:', error);
        statusEl.textContent = 'Connection Failed';
        statusEl.classList.add('show', 'disconnected');
      });

      // Listen for connection events
      givebit.on('connection_lost', () => {
        console.log('Connection lost, attempting to reconnect...');
        statusEl.textContent = 'Reconnecting...';
        statusEl.classList.add('show', 'disconnected');
        statusEl.classList.remove('connected');
      });

      givebit.on('connection_open', () => {
        console.log('Connection restored');
        statusEl.textContent = 'Connected';
        statusEl.classList.add('connected');
        statusEl.classList.remove('disconnected');
        
        if (showStatus) {
          setTimeout(() => {
            statusEl.classList.remove('show');
          }, 3000);
        }
      });

      // Listen for finalized donations
      givebit.on('donation_finalized', (event) => {
        showDonationAlert(event.session);
      });

      // For testing, also show pending/confirmed donations
      const testMode = params.get('test') === 'true';
      if (testMode) {
        givebit.on('donation_pending', (event) => {
          showDonationAlert({ ...event.session, status: 'pending' });
        });
      }
    }).catch((error) => {
      console.error('Failed to load GiveBit SDK:', error);
      statusEl.textContent = 'SDK Load Error';
      statusEl.classList.add('show', 'disconnected');
    });

    function showDonationAlert(donation) {
      const container = document.getElementById('donationContainer');
      
      // Create alert element
      const alert = document.createElement('div');
      alert.className = 'donation-alert';
      
      // Format amount (assume ETH)
      const amount = parseFloat(donation.amount) || 0;
      const formattedAmount = amount.toFixed(4) + ' ETH';
      
      // Get donor wallet (shortened)
      const donor = donation.donor_wallet 
        ? `${donation.donor_wallet.slice(0, 6)}...${donation.donor_wallet.slice(-4)}`
        : 'Anonymous';
      
      // Get memo
      const memo = donation.memo || donation.metadata?.memo || '';
      
      alert.innerHTML = `
        <div class="donation-header">
          <div class="donation-icon">üíù</div>
          <div class="donation-title">New Donation!</div>
        </div>
        <div class="donation-amount">${formattedAmount}</div>
        <div class="donation-donor">From: ${donor}</div>
        ${memo ? `<div class="donation-memo">"${memo}"</div>` : ''}
      `;
      
      container.appendChild(alert);
      
      // Play sound (if available)
      playDonationSound();
      
      // Remove after 5 seconds
      setTimeout(() => {
        alert.remove();
      }, 5000);
      
      // Log for debugging
      console.log('üíù Donation received:', {
        amount: formattedAmount,
        donor,
        memo,
        timestamp: new Date(donation.created_at).toLocaleString()
      });
    }

    function playDonationSound() {
      // Optional: Add sound effect
      // You can host a sound file and play it here
      try {
        const audio = new Audio('donation-sound.mp3');
        audio.volume = 0.5;
        audio.play().catch(() => {
          // Sound playback failed (browser might block autoplay)
        });
      } catch (error) {
        // Sound not available
      }
    }
  </script>
</body>
</html>
